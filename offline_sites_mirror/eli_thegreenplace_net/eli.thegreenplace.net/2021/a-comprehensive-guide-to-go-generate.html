<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<!-- Mirrored from eli.thegreenplace.net/2021/a-comprehensive-guide-to-go-generate by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 16 Feb 2025 23:40:44 GMT -->
<head>
    <title>A comprehensive guide to go generate - Eli Bendersky's website</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="../favicon.ico" rel="icon">

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../theme/css/bootstrap.min.css" type="text/css"/>
    <link href="../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="../theme/css/pygments/vs.css" rel="stylesheet">
    <link rel="stylesheet" href="../theme/css/style.css" type="text/css"/>

        <link href="../feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Eli Bendersky's website ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../index.html" class="navbar-brand">
                <img src="../images/logosmall.png" width="32" height="32"/>
Eli Bendersky's website            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="../pages/about.html">
                        <i class="fa fa-question"></i>
                        <span class="icon-label">About</span>
                    </a>
                </li>
                <li>
                    <a href="../pages/projects.html">
                        <i class="fa fa-github"></i>
                        <span class="icon-label">Projects</span>
                    </a>
                </li>
                <li>
                    <a href="../archives/all.html">
                        <i class="fa fa-th-list"></i>
                        <span class="icon-label">Archives</span>
                    </a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="a-comprehensive-guide-to-go-generate/index.html"
                       rel="bookmark"
                       title="Permalink to A comprehensive guide to go generate">
                        A comprehensive guide to go generate
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="published">
        <i class="fa fa-calendar"></i>
        <time> October 26, 2021 at 20:02</time>
    </span>
<span class="label label-default">Tags</span>
    <a href="../tag/go.html">Go</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Developers have strong tendencies to automate repetitive tasks, and this applies
to writing code as well. Therefore, the topic of <em>metaprogramming</em> is a hot
area of development and research, and hails back to Lisp in the 1960s. One
specific aspect of metaprogramming that has been particularly useful is
<em>code-generation</em>, or writing programs that emit other programs, or parts of
themselves. Languages that support <em>macros</em> have this capability built-in; other
languages extend existing features to support this (e.g. <a class="reference external" href="https://en.wikipedia.org/wiki/Template_metaprogramming">C++ template
metaprogramming</a>).</p>
<p>While Go does not have macros or other forms of metaprogramming, it's a
pragmatic language and it embraces code generation with support in the official
toolchain.</p>
<p>The <tt class="docutils literal">go generate</tt> command has been introduced all the way back <a class="reference external" href="https://go.dev/blog/generate">in Go 1.4</a>, and since then has been widely used in the Go
ecosystem. The Go project itself relies on <tt class="docutils literal">go generate</tt> in dozens of places;
I'll do a quick overview of these use cases later on in the post.</p>
<img alt="Gopher sitting and controlling an electrical generator" class="align-center" src="../images/2021/gopher-with-generator.png" />
<div class="section" id="the-basics">
<h2>The basics</h2>
<p>Let's start with some terminology. The way <tt class="docutils literal">go generate</tt> works is an
orchestration between three major players:</p>
<ul class="simple">
<li><em>Generator</em>: is a program or a script that is invoked by <tt class="docutils literal">go generate</tt>. In
any given project multiple generators may be invoked, a single generator can
be invoked multiple times, etc.</li>
<li><em>Magic comments</em>: are comments formatted in a special way in <tt class="docutils literal">.go</tt> files
that specify which generator to invoke and how. Any comment that starts at
the very beginning of the line with the text <tt class="docutils literal">//go:generate</tt> qualifies.</li>
<li><tt class="docutils literal">go generate</tt>: is the Go tool that reads Go source files,
finds and parses magic comments and runs the generators, as specified.</li>
</ul>
<p>It's very important to emphasize that the above is the whole extent of
automation Go provides for code generation. For anything else, the developer is
free to use whatever workflow works for them. For example, <tt class="docutils literal">go generate</tt>
should always be run manually by the developer; it's never invoked automatically
(say as part of <tt class="docutils literal">go build</tt>). Moreover, since with Go we typically ship
binaries to users or execution environments, it is well understood that <tt class="docutils literal">go
generate</tt> is only run during development (likely just before running <tt class="docutils literal">go
build</tt>); users of Go programs shouldn't know whether parts of the code are
generated and how.</p>
<p>This applies to shipping modules as well; <tt class="docutils literal">go generate</tt> won't run the
generators of imported packages. Therefore, when a project is published,
whatever generated code is part of it should be <em>checked in</em> and distributed
along with the rest of the code.</p>
</div>
<div class="section" id="a-simple-example">
<h2>A simple example</h2>
<p>Learning is best done by doing; to this end, I created a couple of simple Go
projects that will help me illustrate the topics explained by this post. The
first is <a class="reference external" href="https://github.com/eliben/code-for-blog/tree/main/2021/go-generate-guide/samplegentool">samplegentool</a>,
a basic Go tool that's intended to simulate a <em>generator</em>. Here's its entire
source code:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;os&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Running %s go on %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;GOFILE&quot;</span><span class="p">))</span><span class="w"></span>

<span class="w">  </span><span class="nx">cwd</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getwd</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;  cwd = %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">cwd</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;  os.Args = %#v\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;GOARCH&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GOOS&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GOFILE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GOLINE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GOPACKAGE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;DOLLAR&quot;</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ev</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;=&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="nx">ev</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>This tool doesn't read any code and doesn't write any code; all it does is
carefully report how it's invoked. We'll get to the details shortly. Let's first
examine another project - <a class="reference external" href="https://github.com/eliben/code-for-blog/tree/main/2021/go-generate-guide/mymod">mymod</a>.
This is a sample Go module with 3 files split into two packages:</p>
<div class="highlight"><pre><span></span>$ tree
.
├── anotherfile.go
├── go.mod
├── mymod.go
└── mypack
    └── mypack.go
</pre></div>
<p>The contents of these files are fillers; what matters is the <tt class="docutils literal">go:generate</tt>
magic comments in them. Let's take the one in <tt class="docutils literal">mypack/mypack.go</tt> for example:</p>
<div class="highlight"><pre><span></span><span class="c1">//go:generate samplegentool arg1 &quot;multiword arg&quot;</span><span class="w"></span>
</pre></div>
<p>We see that it invokes <tt class="docutils literal">samplegentool</tt> with some arguments. To make this
invocation work, <tt class="docutils literal">samplegentool</tt> should be found somewhere in <tt class="docutils literal">PATH</tt>. This
can be accomplished by running <tt class="docutils literal">go build</tt> in the <tt class="docutils literal">samplegentool</tt> project
to build the binary and then setting <tt class="docutils literal">PATH</tt> accordingly <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a>. Now, if we
run <tt class="docutils literal">go generate <span class="pre">./...</span></tt> in the root of the <tt class="docutils literal">mymod</tt> project, we'll see
something like:</p>
<div class="highlight"><pre><span></span>$ go generate ./...
Running samplegentool go on anotherfile.go
  cwd = /tmp/mymod
  os.Args = []string{&quot;samplegentool&quot;, &quot;arg1&quot;, &quot;arg2&quot;, &quot;arg3&quot;, &quot;arg4&quot;}
   GOARCH = amd64
   GOOS = linux
   GOFILE = anotherfile.go
   GOLINE = 1
   GOPACKAGE = mymod
   DOLLAR = $
Running samplegentool go on mymod.go
  cwd = /tmp/mymod
  os.Args = []string{&quot;samplegentool&quot;, &quot;arg1&quot;, &quot;arg2&quot;, &quot;-flag&quot;}
   GOARCH = amd64
   GOOS = linux
   GOFILE = mymod.go
   GOLINE = 3
   GOPACKAGE = mymod
   DOLLAR = $
Running samplegentool go on mypack.go
  cwd = /tmp/mymod/mypack
  os.Args = []string{&quot;samplegentool&quot;, &quot;arg1&quot;, &quot;multiword arg&quot;}
   GOARCH = amd64
   GOOS = linux
   GOFILE = mypack.go
   GOLINE = 3
   GOPACKAGE = mypack
   DOLLAR = $
</pre></div>
<p>First, note that <tt class="docutils literal">samplegentool</tt> is invoked on each file in which it appears
in a magic comment; this includes sub-directories, because we ran <tt class="docutils literal">go generate</tt>
with the <tt class="docutils literal"><span class="pre">./...</span></tt> pattern. This is really convenient for large projects that
have many generators in various places.</p>
<p>There's a lot of interesting stuff in the output; let's dissect it line by line:</p>
<ul class="simple">
<li><tt class="docutils literal">cwd</tt> reports the working directory where <tt class="docutils literal">samplegentool</tt> is invoked.
This is always the directory where the file with the magic comment
was found; this is guaranteed by <tt class="docutils literal">go generate</tt>, and lets the generator
know where it's located in the directory tree.</li>
<li><tt class="docutils literal">os.Args</tt> reports the command-line arguments passed to the generator.
As the output above demonstrates, this includes flags as well as multi-word
arguments surrounded by quotes.</li>
<li>The env vars passed to the generator are then printed out; see the
<a class="reference external" href="https://pkg.go.dev/cmd/go#hdr-Generate_Go_files_by_processing_source">official documentation</a> for a
full explanation of these. The most interesting env vars here are <tt class="docutils literal">GOFILE</tt>
which specify the file name in which the magic comment was found (this path is
relative to the working directory) and <tt class="docutils literal">GOPACKAGE</tt> that tells the generator
which package this file belongs to.</li>
</ul>
</div>
<div class="section" id="what-can-generators-do">
<h2>What can generators do?</h2>
<p>Now that we have a good understanding of how generators are invoked by
<tt class="docutils literal">go generate</tt>, what can they do? Well, in fact they can do anything we'd like.
Really. Generators are just computer programs, after all. As mentioned earlier,
generated files are typically checked into the source code as well, so
generators may only need to run rarely. In many projects, developers won't run
<tt class="docutils literal">go generate <span class="pre">./...</span></tt> from the root as I did in the example above; rather,
they'll just run specific generators in specific directories as needed.</p>
<p>In the next section I will provide a deep dive of a very popular generator - the
<tt class="docutils literal">stringer</tt> tool. In the meantime, here are some tasks the Go project
itself uses generators for (this is not a full list; all uses can be found
by grepping <tt class="docutils literal">go:generate</tt> in the Go source tree):</p>
<ul class="simple">
<li>The <tt class="docutils literal">gob</tt> package uses generators to emit repetitive helper functions for
encoding/decoding data.</li>
<li>The <tt class="docutils literal">math/bits</tt> package uses a generator to emit fast lookup tables for
some of the bitwise operations it provides.</li>
<li>Several <tt class="docutils literal">crypto</tt> packages use generators to emit hash function shuffle
patterns and repetitive assembly code for certain operations.</li>
<li>Some <tt class="docutils literal">crypto</tt> packages also use generators to grab certificates from
specific HTTP URLs. Obviously, these aren't designed to be run very
frequently...</li>
<li><tt class="docutils literal">net/http</tt> is using a generator to emit various HTTP constants.</li>
<li>There are several interesting uses of generators in the Go runtime's source
code, such as generating assembly code for various tasks, lookup tables
for mathematical operations, etc.</li>
<li>The Go compiler implementation uses a generator to emit repetitive types and
methods for IR nodes.</li>
</ul>
<p>In addition, there are at least two places in the standard library that use
generators for generics-like functionality, where almost duplicate code is
generated from existing code with different types. One place that does this is
the <tt class="docutils literal">sort</tt> package <a class="footnote-reference" href="#footnote-2" id="footnote-reference-2">[2]</a>, and the other is the <tt class="docutils literal">suffixarray</tt> package.</p>
</div>
<div class="section" id="generator-deep-dive-stringer">
<h2>Generator deep-dive: stringer</h2>
<p>One of the most commonly used generators in Go projects is <a class="reference external" href="https://pkg.go.dev/golang.org/x/tools/cmd/stringer">stringer</a> - a tool that automates
the creation of <tt class="docutils literal">String()</tt> methods for types so they implement the
<tt class="docutils literal">fmt.Stringer</tt> interface. It is most frequently used to generate textual
representations for enumerations.</p>
<p>Let's take an example from the standard library (<tt class="docutils literal">math.big</tt> package);
specifically, the <a class="reference external" href="https://pkg.go.dev/math/big#RoundingMode">RoundingMode</a>
type, which is defined as follows:</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">RoundingMode</span><span class="w"> </span><span class="kt">byte</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="nx">ToNearestEven</span><span class="w"> </span><span class="nx">RoundingMode</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">iota</span><span class="w"></span>
<span class="w">  </span><span class="nx">ToNearestAway</span><span class="w"></span>
<span class="w">  </span><span class="nx">ToZero</span><span class="w"></span>
<span class="w">  </span><span class="nx">AwayFromZero</span><span class="w"></span>
<span class="w">  </span><span class="nx">ToNegativeInf</span><span class="w"></span>
<span class="w">  </span><span class="nx">ToPositiveInf</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
<p>At least up to Go 1.18, this is an idiomatic Go enumeration; to make the names
of these enum values printable, we'll need to implement a <tt class="docutils literal">String()</tt>
method for this type that would be a kind of <tt class="docutils literal">switch</tt> statement enumerating
each value with its string representation. This is very repetitive work, which
is why the <tt class="docutils literal">stringer</tt> tool is used.</p>
<p>I've replicated the <tt class="docutils literal">RoundingMode</tt> type and its values in a <a class="reference external" href="https://github.com/eliben/code-for-blog/tree/main/2021/go-generate-guide/stringerusage">small example
module</a>
so we can experiment with the generator more easily. Let's add the appropriate
magic comment to the file:</p>
<div class="highlight"><pre><span></span><span class="c1">//go:generate stringer -type=RoundingMode</span><span class="w"></span>
</pre></div>
<p>We'll discuss the flags <tt class="docutils literal">stringer</tt> accepts shortly. Let's be sure to install
it first:</p>
<div class="highlight"><pre><span></span>$ go install golang.org/x/tools/cmd/stringer@latest
</pre></div>
<p>Now we can run <tt class="docutils literal">go generate</tt>; since in the sample project the file with the
magic comment lives in a sub-package, I'll just run this from the module root:</p>
<div class="highlight"><pre><span></span>$ go generate ./...
</pre></div>
<p>If everything is set up properly, this command will complete successfully
without any standard output. Checking the contents of the project, you'll find
that a file named <tt class="docutils literal">roundingmode_string.go</tt> has been generated, with these
contents:</p>
<div class="highlight"><pre><span></span><span class="c1">// Code generated by &quot;stringer -type=RoundingMode&quot;; DO NOT EDIT.</span><span class="w"></span>

<span class="kn">package</span><span class="w"> </span><span class="kt">float</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;strconv&quot;</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="nx">_</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// An &quot;invalid array index&quot; compiler error signifies that the constant values have changed.</span><span class="w"></span>
<span class="w">  </span><span class="c1">// Re-run the stringer command to generate them again.</span><span class="w"></span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span><span class="w"></span>
<span class="w">  </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">ToNearestEven</span><span class="o">-</span><span class="mi">0</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">ToNearestAway</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">ToZero</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">AwayFromZero</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">ToNegativeInf</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="nx">ToPositiveInf</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">const</span><span class="w"> </span><span class="nx">_RoundingMode_name</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ToNearestEvenToNearestAwayToZeroAwayFromZeroToNegativeInfToPositiveInf&quot;</span><span class="w"></span>

<span class="kd">var</span><span class="w"> </span><span class="nx">_RoundingMode_index</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">uint8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">}</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="nx">RoundingMode</span><span class="p">)</span><span class="w"> </span><span class="nx">String</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">RoundingMode</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_RoundingMode_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;RoundingMode(&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">FormatInt</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">_RoundingMode_name</span><span class="p">[</span><span class="nx">_RoundingMode_index</span><span class="p">[</span><span class="nx">i</span><span class="p">]:</span><span class="nx">_RoundingMode_index</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>The <tt class="docutils literal">stringer</tt> tool has multiple codegen strategies, depending on the nature
of the enumeration values it's invoked on. Our case is the simplest one with a
&quot;single consecutive run&quot; of values. <tt class="docutils literal">stringer</tt> will generate somewhat
different code if the values form multiple consecutive runs, and yet another
version if the values form no run at all. For fun and education, study the
source of <tt class="docutils literal">stringer</tt> for the details; here let's focus on the currently used
strategy.</p>
<p>First, the <tt class="docutils literal">_RoundingMode_name</tt> constant is used to efficiently hold all
string representations in a single consecutive string. <tt class="docutils literal">_RoundingMode_index</tt>
serves as a lookup table into this string; for example let's take <tt class="docutils literal">ToZero</tt>,
which has the value 2. <tt class="docutils literal">_RoundingMode_index[2]</tt> is 26, so the code will index
into <tt class="docutils literal">_RoundingMode_name</tt> at index 26, which leads us to the <tt class="docutils literal">ToZero</tt> part
(the end is the <em>next</em> index, 32 in this case).</p>
<p>The code in <tt class="docutils literal">String()</tt> also has a fallback in case more enum values were added
but the <tt class="docutils literal">stringer</tt> tool was not rerun. In this case the value produced will
be <tt class="docutils literal">RoundingMode(N)</tt> where <tt class="docutils literal">N</tt> is the numeric value.</p>
<p>This fallback is useful because nothing in the Go toolchain guarantees that
generated code will remain in sync with the source; as mentioned before, running
the generators is entirely the developer's responsibility.</p>
<p>What about the odd code in <tt class="docutils literal">func _()</tt> though? First, notice that it literally
compiles to nothing: the function doesn't return anything, has no side effects
and isn't invoked. The goal of this function is to serve as a
<em>compilation guard</em>; it's an extra bit of safety in case the original enum
changes in a way that's fundamentally incompatible with the generated code, and
the developer forgets to rerun <tt class="docutils literal">go generate</tt>. Specifically, it will protect
against existing enum values being modified. In this event, unless <tt class="docutils literal">go
generate</tt> was rerun, the <tt class="docutils literal">String()</tt> method may succeed but produce completely
wrong values. The compilation guard tries to catch this case by having code that
will fail to compile an out-of-bounds array lookup.</p>
<p>Now let's talk a bit about how <tt class="docutils literal">stringer</tt> works; first, it's instructional
to read its <tt class="docutils literal"><span class="pre">-help</span></tt>:</p>
<div class="highlight"><pre><span></span>$ stringer -help
Usage of stringer:
  stringer [flags] -type T [directory]
  stringer [flags] -type T files... # Must be a single package
For more information, see:
  https://pkg.go.dev/golang.org/x/tools/cmd/stringer
Flags:
  -linecomment
      use line comment text as printed text when present
  -output string
      output file name; default srcdir/&lt;type&gt;_string.go
  -tags string
      comma-separated list of build tags to apply
  -trimprefix prefix
      trim the prefix from the generated constant names
  -type string
      comma-separated list of type names; must be set
</pre></div>
<p>We've used the <tt class="docutils literal"><span class="pre">-type</span></tt> parameter to tell <tt class="docutils literal">stringer</tt> which type(s) to
generate the <tt class="docutils literal">String()</tt> method for. In a realistic code base one
may want to invoke the tool on a package that has a number of types defined
within it; in this case, we likely want <tt class="docutils literal">stringer</tt> to produce <tt class="docutils literal">String()</tt>
methods for only specific types.</p>
<p>We haven't specified the <tt class="docutils literal"><span class="pre">-output</span></tt> flag, so the default is used; in this case,
the generated file is named <tt class="docutils literal">roundingmode_string.go</tt>.</p>
<p>Sharp-eyed readers will notice that when we invoked <tt class="docutils literal">stringer</tt>, we didn't
specify what file it's supposed to use as input. A quick scan of the tool's
source code shows that it doesn't use the <tt class="docutils literal">GOFILE</tt> env var either. So how does
it know which files to analyze? It turns out that <tt class="docutils literal">stringer</tt> uses
<tt class="docutils literal">golang.org/x/tools/go/packages</tt> to load the whole package from its
current working directory (which, as you recall, is the directory the file
containing the magic comment is in). This means that no matter what file the
magic comment is in, <tt class="docutils literal">stringer</tt> will analyze the whole package by default.
If you think about it for a moment, it makes sense because who said that the
constants have to be in the same file as the type declaration, for instance? In
Go, a file is just a convenient container for code; a <em>package</em> is the real unit
of input the tooling cares about.</p>
</div>
<div class="section" id="in-source-generators-and-build-tags">
<h2>In-source generators and build tags</h2>
<p>So far we've assumed that the generator is somewhere in <tt class="docutils literal">PATH</tt> while <tt class="docutils literal">go
generate</tt> is running, but this may not always be the case.</p>
<p>Consider a very common scenario where your module has its own generator that's
only useful for this specific module. When someone is hacking on the module,
you'd like them to be able to clone the code, run <tt class="docutils literal">go generate</tt> and <tt class="docutils literal">go
build</tt>, etc. However, if magic comments assume that generators are always in
<tt class="docutils literal">PATH</tt> this won't work unless the generators are built and properly pointed to
before running <tt class="docutils literal">go generate</tt>.</p>
<p>The solution in Go is simple because of <tt class="docutils literal">go run</tt>, which is a perfect match
for running generators that are just <tt class="docutils literal">.go</tt> files somewhere in the module's
tree. A simple example is <a class="reference external" href="https://github.com/eliben/code-for-blog/tree/main/2021/go-generate-guide/insourcegenerator">available here</a>.
This is a package file with a magic comment:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">mypack</span><span class="w"></span>

<span class="c1">//go:generate go run gen.go arg1 arg2</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="nx">PackFunc</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;insourcegenerator/mypack.PackFunc&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Notice how the generator is invoked here: with <tt class="docutils literal">go run gen.go</tt>. This means
that <tt class="docutils literal">go generate</tt> will expect to find <tt class="docutils literal">gen.go</tt> in the same directory as the
file containing the magic comment. The contents of <tt class="docutils literal">gen.go</tt> are:</p>
<div class="highlight"><pre><span></span><span class="c1">//go:build ignore</span><span class="w"></span>

<span class="kn">package</span><span class="w"> </span><span class="nx">main</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;fmt&quot;</span><span class="w"></span>
<span class="w">  </span><span class="s">&quot;os&quot;</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ... same main() as the simple example at the top of the post</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>It's just a small Go program (in package <tt class="docutils literal">main</tt>). The only thing of note is
the <tt class="docutils literal">//go:build</tt> constraint that tells the Go toolchain to ignore this file
when building the project <a class="footnote-reference" href="#footnote-3" id="footnote-reference-3">[3]</a>. Indeed, <tt class="docutils literal">gen.go</tt> is not a part of the package;
it's in <tt class="docutils literal">package main</tt> itself and is intended to be run with <tt class="docutils literal">go
generate</tt> instead of being compiled into the package.</p>
<p>The standard library has <em>many</em> examples of small programs intended to be
invoked with <tt class="docutils literal">go run</tt> that serve as generators.</p>
<p>The typical pattern is that 3 files are involved in code generation, and these
all coexist in the same directory/package:</p>
<ul class="simple">
<li>The <em>source file</em> contains some of the package's code, along with a magic
comment to invoke a generator with <tt class="docutils literal">go run</tt>.</li>
<li>The <em>generator</em>, which is a single <tt class="docutils literal">.go</tt> file with <tt class="docutils literal">package main</tt>;
this generator is invoked by the <tt class="docutils literal">go run</tt> in a magic comment from the
<em>source file</em> to produce the <em>generated file</em>. The generator <tt class="docutils literal">.go</tt> file will
typically have a <tt class="docutils literal">//go:build ignore</tt> constraint to exclude it from the build
of the package itself.</li>
<li>The <em>generated file</em> is emitted by the generator; in some conventions it would
have the same name as the <em>source</em> file, but followed by <tt class="docutils literal">_gen</tt> (like
<tt class="docutils literal">pack.go</tt> --&gt; <tt class="docutils literal">pack_gen.go</tt>); alternatively it could be some sort of
prefix (like <tt class="docutils literal">gen</tt>). The code in the generated file is in the same package
as the code in the <em>source file</em>. In many cases, the generated file contains
some implementation details as unexported symbols; the <em>source file</em> can
refer to this in its code because the two files are in the same package.</li>
</ul>
<p>Of course, none of this is mandated by the tooling - it just describes a common
convention; specific projects can be set up in a different way (where a single
generator emits code for multiple packages, for example).</p>
</div>
<div class="section" id="advanced-features">
<h2>Advanced features</h2>
<p>This section discusses some of the advanced or lesser used features of <tt class="docutils literal">go
generate</tt>.</p>
<div class="section" id="the-command-flag">
<h3>The -command flag</h3>
<p>This flag lets us define aliases for <tt class="docutils literal">go:generate</tt> lines; this could be
useful if some generator was a multi-word command that we wanted to shorten for
multiple invocations.</p>
<p>The original motivation was likely to shorten <tt class="docutils literal">go tool yacc</tt> to just <tt class="docutils literal">yacc</tt>
with:</p>
<div class="highlight"><pre><span></span><span class="c1">//go:generate -command yacc go tool yacc</span><span class="w"></span>
</pre></div>
<p>After which <tt class="docutils literal">yacc</tt> could be invoked multiple times with just this 4-letter
name instead of three words.</p>
<p>Interestingly, <tt class="docutils literal">go tool yacc</tt> was removed from the core Go toolchain <a class="reference external" href="https://tip.golang.org/doc/go1.8#tool_yacc">in 1.8</a>, and I haven't found any usage of
<tt class="docutils literal"><span class="pre">-command</span></tt> in either the main Go repository (outside of testing <tt class="docutils literal">go
generate</tt> itself) or the <tt class="docutils literal">x/tools</tt> modules.</p>
</div>
<div class="section" id="the-run-flag">
<h3>The -run flag</h3>
<p>This flag is for the <tt class="docutils literal">go generate</tt> command itself, used to select which
generators to run. Recall our simple example where we had 3 invocations of
<tt class="docutils literal">samplegentool</tt> in the same project. We can select only one of them to run
with the <tt class="docutils literal"><span class="pre">-run</span></tt> flag:</p>
<div class="highlight"><pre><span></span>$ go generate -run multi ./...
Running samplegentool go on mypack.go
  cwd = /tmp/mymod/mypack
  os.Args = []string{&quot;samplegentool&quot;, &quot;arg1&quot;, &quot;multiword arg&quot;}
   GOARCH = amd64
   GOOS = linux
   GOFILE = mypack.go
   GOLINE = 3
   GOPACKAGE = mypack
   DOLLAR = $
</pre></div>
<p>The utility of this should be obvious for debugging: in a large project with
multiple generators, we often want to run only a subset for debugging / quick
edit-run loop purposes.</p>
</div>
<div class="section" id="dollar">
<h3>DOLLAR</h3>
<p>Of the env vars auto-magically passed into generators, one stands out -
<tt class="docutils literal">DOLLAR</tt>. What is it for? Why dedicate an env var to a character? There is
no use of this env var in the Go source tree.</p>
<p>The origin of <tt class="docutils literal">DOLLAR</tt> can be traced to <a class="reference external" href="https://go-review.googlesource.com/c/go/+/8091/">this commit by Rob Pike</a>. As the change description
says, the motivation here is passing the <tt class="docutils literal">$</tt> char into a generator without
complicated <a class="reference external" href="http://www.gnu.org/savannah-checkouts/gnu/bash/manual/bash.html#Quoting">shell escaping</a>.
This is useful if <tt class="docutils literal">go generate</tt> invokes a shell script or something that takes
a regexp as an argument.</p>
<p>The effect of <tt class="docutils literal">DOLLAR</tt> can be observed with our <tt class="docutils literal">samplegentool</tt> generator.
If we change one of the magic comments to:</p>
<div class="highlight"><pre><span></span><span class="c1">//go:generate samplegentool arg1 $somevar</span><span class="w"></span>
</pre></div>
<p>The generator reports its arguments to be</p>
<div class="highlight"><pre><span></span>os.Args = []string{&quot;samplegentool&quot;, &quot;arg1&quot;, &quot;&quot;}
</pre></div>
<p>This is because <tt class="docutils literal">$somevar</tt> is interpreted by the shell as referencing the
<tt class="docutils literal">somevar</tt> variable, which doesn't exist so its default value is empty. Instead
we can use <tt class="docutils literal">DOLLAR</tt> as follows:</p>
<div class="highlight"><pre><span></span><span class="c1">//go:generate samplegentool arg1 ${DOLLAR}somevar</span><span class="w"></span>
</pre></div>
<p>And then the generator reports</p>
<div class="highlight"><pre><span></span>os.Args = []string{&quot;samplegentool&quot;, &quot;arg1&quot;, &quot;$somevar&quot;}
</pre></div>
<hr class="docutils" />
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td>An alternative approach is place a link to <tt class="docutils literal">samplegentool</tt> in the
<tt class="docutils literal">GOBIN</tt> directory. If your <tt class="docutils literal">GOBIN</tt> is not set, it defaults to
<tt class="docutils literal">GOPATH/bin</tt>. If <tt class="docutils literal">GOPATH</tt> is not set either (which is what I do,
since I'm all in on modules), it should be in <tt class="docutils literal">$HOME/go/bin</tt>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-2">[2]</a></td><td>The <tt class="docutils literal">sort</tt> package is a very interesting example, because it actually
<em>parses</em> the code of the package using <tt class="docutils literal">go/parser</tt> and <tt class="docutils literal">go/ast</tt> and
uses that as a basis for generating an alternative version. This approach
may change with <a class="reference external" href="https://go-review.googlesource.com/c/go/+/353069/">CL 353069</a>, though.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-3">[3]</a></td><td>Looking at real-world examples of build constraints you'll likely see
<tt class="docutils literal">// +build ignore</tt> instead. This is the older syntax which was
superseded by the <tt class="docutils literal">go:build</tt> syntax <a class="reference external" href="https://go.googlesource.com/proposal/+/master/design/draft-gobuild.md">in Go 1.17</a>.
For the time being, most generators will likely include <em>both</em> kinds of
constraints, to support building with Go 1.16 and earlier, as well as
future-proofing for upcoming releases.</td></tr>
</tbody>
</table>
</div>
</div>

            </div>
            <!-- /.entry-content -->
<hr/>
<div class="dotted-links">
<p class="align-center">
For comments, please send me
<a href="mailto:eliben@gmail.com"><i class="fa fa-envelope-o"></i> an email</a>.
</p>
</div>        </article>
    </section>

    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">
            &copy; 2003-2025 Eli Bendersky
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://code.jquery.com/jquery-2.2.4.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../theme/js/bootstrap.min.js"></script>

<!--
  Using goatcounter to count visitors. The count.js script is vendored in.
-->
<script data-goatcounter="https://stats.thegreenplace.net/count"
        async src="../theme/js/count.js"></script>
</body>

<!-- Mirrored from eli.thegreenplace.net/2021/a-comprehensive-guide-to-go-generate by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 16 Feb 2025 23:40:44 GMT -->
</html>