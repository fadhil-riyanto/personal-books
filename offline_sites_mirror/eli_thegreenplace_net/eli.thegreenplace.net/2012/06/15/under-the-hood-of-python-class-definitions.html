<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<!-- Mirrored from eli.thegreenplace.net/2012/06/15/under-the-hood-of-python-class-definitions by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 17 Feb 2025 00:02:56 GMT -->
<head>
    <title>Under the hood of Python class definitions - Eli Bendersky's website</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="../../../favicon.ico" rel="icon">

    <!-- Bootstrap -->
        <link rel="stylesheet" href="../../../theme/css/bootstrap.min.css" type="text/css"/>
    <link href="../../../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="../../../theme/css/pygments/vs.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../theme/css/style.css" type="text/css"/>

        <link href="../../../feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Eli Bendersky's website ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../../../index.html" class="navbar-brand">
                <img src="../../../images/logosmall.png" width="32" height="32"/>
Eli Bendersky's website            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="../../../pages/about.html">
                        <i class="fa fa-question"></i>
                        <span class="icon-label">About</span>
                    </a>
                </li>
                <li>
                    <a href="../../../pages/projects.html">
                        <i class="fa fa-github"></i>
                        <span class="icon-label">Projects</span>
                    </a>
                </li>
                <li>
                    <a href="../../../archives/all.html">
                        <i class="fa fa-th-list"></i>
                        <span class="icon-label">Archives</span>
                    </a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<div class="container">
    <div class="row">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="under-the-hood-of-python-class-definitions.html"
                       rel="bookmark"
                       title="Permalink to Under the hood of Python class definitions">
                        Under the hood of Python class definitions
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="published">
        <i class="fa fa-calendar"></i>
        <time> June 15, 2012 at 05:51</time>
    </span>
<span class="label label-default">Tags</span>
    <a href="../../../tag/python-internals.html">Python internals</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                
        <p>This is a fast-paced walk-through of the internals of defining new classes in Python. It shows what actually happens inside the Python interpreter when a new class definition is encountered and processed. Beware, this is advanced material. If the prospect of pondering the metaclass of the metaclass of your class makes you feel nauseated, you better stop now.</p>
<p>The focus is on the official (CPython) implementation of Python 3. For modern releases of Python 2 the concepts are similar, although there will be some slight differences in the details.</p>
<div class="section" id="on-the-bytecode-level">
<h3>On the bytecode level</h3>
<p>I'll start right with the bytecode, ignoring all the good work done by the Python compiler <a class="footnote-reference" href="#id11" id="id1">[1]</a>. For simplicity, this function will be used to demonstrate the bytecode generated by a class definition, since it's easy to disassemble functions:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #00007f; font-weight: bold">def</span> <span style="color: #00007f">myfunc</span>():
    <span style="color: #00007f; font-weight: bold">class</span> <span style="color: #00007f">Joe</span>:
        attr = <span style="color: #007f7f">100.02</span>
        <span style="color: #00007f; font-weight: bold">def</span> <span style="color: #00007f">foo</span>(<span style="color: #00007f">self</span>):
            <span style="color: #00007f; font-weight: bold">return</span> <span style="color: #007f7f">2</span>
</pre></div>
<p>Disassembling <tt class="docutils literal">myfunc</tt> will show us the steps needed to define a new class:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">&gt;&gt;&gt; dis.disassemble(myfunc.__code__)
 <span style="color: #007f7f">14</span>           <span style="color: #007f7f">0</span> LOAD_BUILD_CLASS
              <span style="color: #007f7f">1</span> LOAD_CONST               <span style="color: #007f7f">1</span> (&lt;code <span style="color: #00007f">object</span> Joe at <span style="color: #007f7f">0x7fe226335b80</span>, <span style="color: #00007f">file</span> <span style="color: #7f007f">&quot;disassemble.py&quot;</span>, line <span style="color: #007f7f">14</span>&gt;)
              <span style="color: #007f7f">4</span> LOAD_CONST               <span style="color: #007f7f">2</span> (<span style="color: #7f007f">&#39;Joe&#39;</span>)
              <span style="color: #007f7f">7</span> MAKE_FUNCTION            <span style="color: #007f7f">0</span>
             <span style="color: #007f7f">10</span> LOAD_CONST               <span style="color: #007f7f">2</span> (<span style="color: #7f007f">&#39;Joe&#39;</span>)
             <span style="color: #007f7f">13</span> CALL_FUNCTION            <span style="color: #007f7f">2</span>
             <span style="color: #007f7f">16</span> STORE_FAST               <span style="color: #007f7f">0</span> (Joe)
             <span style="color: #007f7f">19</span> LOAD_CONST               <span style="color: #007f7f">0</span> (<span style="color: #00007f">None</span>)
             <span style="color: #007f7f">22</span> RETURN_VALUE
</pre></div>
<p>The number immediately preceding the instruction name is its offset in the binary representation of the code object. All the instructions until and including the one at offset 16 are for defining the class. The last two instructions are for <tt class="docutils literal">myfunc</tt> to return <tt class="docutils literal">None</tt>.</p>
<p>Let's go through them, step by step. Documentation of the Python bytecode instructions is available in the <a class="reference external" href="http://docs.python.org/dev/library/dis.htm">dis module</a>.</p>
<p><tt class="docutils literal">LOAD_BUILD_CLASS</tt> is a special instruction used for creating classes. It pushes the function <tt class="docutils literal">builtins.__build_class__</tt> onto the stack. We'll examine this function in much detail later.</p>
<p>Next, a code object, followed by a name (<tt class="docutils literal">Joe</tt>) are pushed onto the stack as well. The code object is interesting, let's peek inside:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">&gt;&gt;&gt; dis.disassemble(myfunc.__code__.co_consts[<span style="color: #007f7f">1</span>])
 <span style="color: #007f7f">14</span>           <span style="color: #007f7f">0</span> LOAD_FAST                <span style="color: #007f7f">0</span> (__locals__)
              <span style="color: #007f7f">3</span> STORE_LOCALS
              <span style="color: #007f7f">4</span> LOAD_NAME                <span style="color: #007f7f">0</span> (__name__)
              <span style="color: #007f7f">7</span> STORE_NAME               <span style="color: #007f7f">1</span> (__module__)
             <span style="color: #007f7f">10</span> LOAD_CONST               <span style="color: #007f7f">0</span> (<span style="color: #7f007f">&#39;myfunc.&lt;locals&gt;.Joe&#39;</span>)
             <span style="color: #007f7f">13</span> STORE_NAME               <span style="color: #007f7f">2</span> (__qualname__)

 <span style="color: #007f7f">15</span>          <span style="color: #007f7f">16</span> LOAD_CONST               <span style="color: #007f7f">1</span> (<span style="color: #007f7f">100.02</span>)
             <span style="color: #007f7f">19</span> STORE_NAME               <span style="color: #007f7f">3</span> (attr)

 <span style="color: #007f7f">16</span>          <span style="color: #007f7f">22</span> LOAD_CONST               <span style="color: #007f7f">2</span> (&lt;code <span style="color: #00007f">object</span> foo at <span style="color: #007f7f">0x7fe226335c40</span>, <span style="color: #00007f">file</span> <span style="color: #7f007f">&quot;disassemble.py&quot;</span>, line <span style="color: #007f7f">16</span>&gt;)
             <span style="color: #007f7f">25</span> LOAD_CONST               <span style="color: #007f7f">3</span> (<span style="color: #7f007f">&#39;myfunc.&lt;locals&gt;.Joe.foo&#39;</span>)
             <span style="color: #007f7f">28</span> MAKE_FUNCTION            <span style="color: #007f7f">0</span>
             <span style="color: #007f7f">31</span> STORE_NAME               <span style="color: #007f7f">4</span> (foo)
             <span style="color: #007f7f">34</span> LOAD_CONST               <span style="color: #007f7f">4</span> (<span style="color: #00007f">None</span>)
             <span style="color: #007f7f">37</span> RETURN_VALUE
</pre></div>
<p>This code defines the innards of the class. Some generic bookkeeping, followed by definitions for the <tt class="docutils literal">attr</tt> attribute and <tt class="docutils literal">foo</tt> method.</p>
<p>Now let's get back to the first disassembly. The next instruction (at offset 7) is <tt class="docutils literal">MAKE_FUNCTION</tt> <a class="footnote-reference" href="#id12" id="id2">[2]</a>. This instruction pulls two things from the stack - a name and a code object. So in our case, it gets the name <tt class="docutils literal">Joe</tt> and the code object we saw disassembled above. It creates a function with the given name and the code object as its code and pushes it back to the stack.</p>
<p>This is followed by once again pushing the name <tt class="docutils literal">Joe</tt> onto the stack. Here's what the stack looks like now (TOS means &quot;top of stack&quot;):</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">TOS&gt; name &quot;Joe&quot;
     function &quot;Joe&quot; with code for defining the class
     function builtins.__build_class__
     -----------------------------------------------
</pre></div>
<p>At this point (offset 13), <tt class="docutils literal">CALL_FUNCTION 2</tt> is executed. The 2 simply means that the function was passed two positional arguments (and no keyword arguments). <tt class="docutils literal">CALL_FUNCTION</tt> first takes the arguments from the stack (the rightmost on top), and then the function itself. So the call is equivalent to:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">builtins.__build_class__(function defining &quot;Joe&quot;, &quot;Joe&quot;)
</pre></div>
</div>
<div class="section" id="build-me-a-class-please">
<h3>Build me a class, please</h3>
<p>A quick peek into the <tt class="docutils literal">builtins</tt> module in <tt class="docutils literal">Python/bltinmodule.c</tt> reveals that <tt class="docutils literal">__build_class__</tt> is implemented by the function <tt class="docutils literal">builtin___build_class__</tt> (I'll call it BBC for simplicity) in the same file.</p>
<p>As any Python function, BBC accepts both positional and keyword arguments. The positional arguments are:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">func, name, base1, base2, ... baseN
</pre></div>
<p>So we see only the function and name were passed for <tt class="docutils literal">Joe</tt>, since it has no base classes. The only keyword argument BBC understands is <tt class="docutils literal">metaclass</tt> <a class="footnote-reference" href="#id13" id="id3">[3]</a>, allowing the Python 3 way of defining <a class="reference external" href="../../../2011/08/14/python-metaclasses-by-example/index.html">metaclasses</a>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #00007f; font-weight: bold">class</span> <span style="color: #00007f">SomeOtherJoe</span>(metaclass=JoeMeta):
  [...]
</pre></div>
<p>So back to BBC, here's what it does <a class="footnote-reference" href="#id14" id="id4">[4]</a>:</p>
<ol class="arabic simple">
<li>The first chunk of code deals with extracting the arguments and setting defaults.</li>
<li>Next, if no metaclass is supplied, BBC looks at the base classes and takes the metaclass of the first base class. If there are no base classes, the default metaclass <tt class="docutils literal">type</tt> is used.</li>
<li>If the metaclass is really a class (note that in Python any callable can be given as a metaclass), look at the bases again to determine &quot;the most derived&quot; metaclass.</li>
</ol>
<p>The last point deserves a bit of elaboration. If our class has bases, then some rules apply for the metaclasses that are allowed. The metaclasses of its bases must be either subclasses or superclasses of our class's metaclass. Any other arrangement will result in this <tt class="docutils literal">TypeError</tt>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">metaclass conflict: the metaclass of a derived class must be a (non-strict)
                    subclass of the metaclasses of all its bases
</pre></div>
<p>Eventually, given that there are no conflicts, the most derived metaclass will be chosen. The most derived metaclass is the one which is a subtype of the explicitly specified metaclass and the metaclasses of all the base classes. In other words, if our class's metaclass is <tt class="docutils literal">Meta1</tt>, only one of the bases has a metaclass and that's <tt class="docutils literal">Meta2</tt>, and <tt class="docutils literal">Meta2</tt> is a subclass of <tt class="docutils literal">Meta1</tt>, it is <tt class="docutils literal">Meta2</tt> that will be picked to serve as the eventual metaclass of our class.</p>
<ol class="arabic simple" start="4">
<li>At this point BBC has a metaclass <a class="footnote-reference" href="#id15" id="id5">[5]</a>, so it starts by calling its <tt class="docutils literal">__prepare__</tt> method to create a namespace dictionary for the class. If there's no such method, an empty dict is used.</li>
</ol>
<p>As documented in the <a class="reference external" href="http://docs.python.org/dev/reference/datamodel.html">data model reference</a>:</p>
<blockquote>
If the metaclass has a __prepare__() attribute (usually implemented as a class or static method), it is called before the class body is evaluated with the name of the class and a tuple of its bases for arguments. It should return an object that supports the mapping interface that will be used to store the namespace of the class. The default is a plain dictionary. This could be used, for example, to keep track of the order that class attributes are declared in by returning an ordered dictionary.</blockquote>
<ol class="arabic simple" start="5">
<li>The function argument is invoked, passing the namespace dict as the only argument. If we look back at the disassembly of this function (the second one), we see that the first argument is placed into the <tt class="docutils literal">f_locals</tt> attribute of the frame (with the <tt class="docutils literal">STORE_LOCALS</tt> instruction). In other words, this dictionary is then used to populate the class attributes. The function itself returns <tt class="docutils literal">None</tt> - its outcome is modifying the namespace dictionary.</li>
<li>Finally, the metaclass is called with the name, list of bases and namespace dictionary as arguments.</li>
</ol>
<p>The last step defers to the metaclass to actually create a new class with the given definition. <a class="reference external" href="../../../2011/08/14/python-metaclasses-by-example/index.html">Recall that</a> when some class <tt class="docutils literal">MyKlass</tt> has a metaclass <tt class="docutils literal">MyMeta</tt>, then the class definition of <tt class="docutils literal">MyKlass</tt> is equivalent to <a class="footnote-reference" href="#id16" id="id6">[6]</a>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">MyKlass = MyMeta(name, bases, namespace_dict)
</pre></div>
<p>The flow of BBC outlined above directly embodies this equivalence.</p>
<p>So what happens next? Well, the metaclass <tt class="docutils literal">MyMeta</tt> is a class, right? And what happens when a class is &quot;called&quot;? <a class="reference external" href="../../04/16/python-object-creation-sequence/index.html">It's instantiated</a>. How is a class's instantiation done? By invoking its metaclass's <tt class="docutils literal">__call__</tt>. So wait, this is the metaclass's metaclass we're talking about here, right? Yes! A metaclass is just a class, after all <a class="footnote-reference" href="#id17" id="id7">[7]</a>, and has a metaclass of its own - so Python has to keep the meta-flow going.</p>
<p>Realistically, what probably happens is this:</p>
<p>Most chances are that your class has no metaclass specified explicitly. Then, its default metaclass is <tt class="docutils literal">type</tt>, so the call above is actually:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">MyKlass = <span style="color: #00007f">type</span>(name, bases, namespace_dict)
</pre></div>
<p>The metaclass of <tt class="docutils literal">type</tt> happens to be <tt class="docutils literal">type</tt> itself, so here <tt class="docutils literal">type.__call__</tt> is called.</p>
<p>In the more complex case that your class <em>does</em> have a metaclass, most chances are that the metaclass itself has no metaclass <a class="footnote-reference" href="#id18" id="id8">[8]</a>, so <tt class="docutils literal">type</tt> is used for it. Therefore, the <tt class="docutils literal"><span class="pre">MyMeta(...)</span></tt> call is also served by <tt class="docutils literal">type.__call__</tt>.</p>
</div>
<div class="section" id="type-call">
<h3>type_call</h3>
<p>In <tt class="docutils literal">Objects/typeobject.c</tt>, the <tt class="docutils literal">type.__call__</tt> slot is getting mapped to the function <tt class="docutils literal">type_call</tt>. I've already spent some time explaining <a class="reference external" href="../../04/16/python-object-creation-sequence/index.html">how it works</a>, so it's important to review that article at this point.</p>
<p>Things are a bit different here, however. The <a class="reference external" href="../../04/16/python-object-creation-sequence/index.html">object creation sequence article</a> explained how instances are created, so the <tt class="docutils literal">tp_new</tt> slot called from <tt class="docutils literal">type_call</tt> went to <tt class="docutils literal">object</tt>. Here, since <tt class="docutils literal">type_call</tt> will actually call <tt class="docutils literal">tp_new</tt> on a metaclass, and the metaclass's base is <tt class="docutils literal">type</tt> (see <a class="reference external" href="../../04/03/the-fundamental-types-of-python-a-diagram/index.html">this diagram</a>), we'll have to study how the <tt class="docutils literal">type_new</tt> function (also from <tt class="docutils literal">Objects/typeobject.c</tt>) works.</p>
</div>
<div class="section" id="a-brief-recap">
<h3>A brief recap</h3>
<p>I feel that the flow here is relatively convoluted, so lest we lose focus, let's have a brief recap of how we got thus far. The following is a much simplified version of the flow described so far in this article:</p>
<ol class="arabic simple">
<li>When a new class <tt class="docutils literal">Joe</tt> is defined...</li>
<li>The Python interpreter arranges the builtin function <tt class="docutils literal">builtin__build_class__</tt> (BBC) to be called, giving it the class name and its innards compiled into a code object.</li>
<li>BBC finds the metaclass of <tt class="docutils literal">Joe</tt> and calls it to create the new class.</li>
<li>When any class in Python is called, it means that its metaclass's <tt class="docutils literal">tp_call</tt> slot is invoked. So to create <tt class="docutils literal">Joe</tt>, this is the <tt class="docutils literal">tp_call</tt> of its metaclass's metaclass. In most cases this is the <tt class="docutils literal">type_call</tt> function (since the metaclass's metaclass is almost always <tt class="docutils literal">type</tt>, or something that eventually delegates to it).</li>
<li><tt class="docutils literal">type_call</tt> creates a new instance of the type it's bound to by calling its <tt class="docutils literal">tp_new</tt> slot.</li>
<li>In our case, that is served by the <tt class="docutils literal">type_new</tt> function.</li>
</ol>
<p>The next section picks up from step 6.</p>
</div>
<div class="section" id="type-new">
<h3>type_new</h3>
<p>The <tt class="docutils literal">type_new</tt> function is a complex beast - it's over 400 lines long. There's a good reason for this, however, since it plays a very fundamental role in the Python object system. It's literally responsible for creating all Python types. I'll go over its functionality in major blocks, pasting short snippets of code where relevant.</p>
<p>Let's start at the beginning. The signature of <tt class="docutils literal">type_new</tt> is:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #00007f; font-weight: bold">static</span> PyObject *
type_new(PyTypeObject *metatype, PyObject *args, PyObject *kwds)
</pre></div>
<p>When called to create our class <tt class="docutils literal">Joe</tt>, the arguments will be:</p>
<ul class="simple">
<li><tt class="docutils literal">metatype</tt> - the metaclass, so it's <tt class="docutils literal">type</tt> itself.</li>
<li><tt class="docutils literal">args</tt> - we saw in the description of BBC above that this is the class name, list of base classes and a namespace dict.</li>
<li><tt class="docutils literal">kwds</tt> - since <tt class="docutils literal">Joe</tt> has no metaclass, this will be empty.</li>
</ul>
<p>At this point, it may be useful <a class="reference external" href="../../../2011/08/14/python-metaclasses-by-example/index.html">to recall that</a>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #00007f; font-weight: bold">class</span> <span style="color: #00007f">Joe</span>:
  ... contents
</pre></div>
<p>Is equivalent to:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%">Joe = <span style="color: #00007f">type</span>(<span style="color: #7f007f">&#39;joe&#39;</span>, (), <span style="color: #00007f">dict</span> of contents)
</pre></div>
<p><tt class="docutils literal">type_new</tt> serves both approaches, of course.</p>
<p>It starts by handling the special 1-argument call of the <tt class="docutils literal">type</tt> function, which returns the type. Then, it tries to see if the requested type has a metaclass that's more suitable than the one passed in. This is necessary to handle a direct call to <tt class="docutils literal">type</tt> as shown above - if one of the bases has a metaclass, that metaclass should be used for the creation <a class="footnote-reference" href="#id19" id="id9">[9]</a>.</p>
<p>Next, <tt class="docutils literal">type_new</tt> handles some special class methods (for example <tt class="docutils literal">__slots__</tt>).</p>
<p>Finally, the type object itself is allocated and initialized. Since the <a class="reference external" href="http://www.python.org/download/releases/2.2/descrintro/">unification of types and classes</a> in Python, user-defined classes are represented similarly to built-in types inside the CPython VM. However, there's still a difference. Unlike built-in types (and new types exported by C extension) which are statically allocated and are essentially &quot;singletons&quot;, user-defined classes have to be implemented by dynamically allocated type objects on the heap <a class="footnote-reference" href="#id20" id="id10">[10]</a>. For this purpose, <tt class="docutils literal">Include/object.h</tt> defines an &quot;extended type object&quot;, <tt class="docutils literal">PyHeapTypeObject</tt>. This struct starts with a <tt class="docutils literal">PyTypeObject</tt> member, so it can be passed around to Python C code expecting any normal type. The extra information it carries is used mainly for book-keeping in the type-handling code (<tt class="docutils literal">Objects/typeobject.c</tt>). <tt class="docutils literal">PyHeapTypeObject</tt> is an interesting type to discuss but would deserve an article of its own, so I'll stop right here.</p>
<p>Just as an example of one of the special cases handled by <tt class="docutils literal">type_new</tt> for members of new classes, let's look at <tt class="docutils literal">__new__</tt>.  The data model reference <a class="reference external" href="http://docs.python.org/dev/reference/datamodel.html#object.__new__">says</a> about it:</p>
<blockquote>
Called to create a new instance of class cls. __new__() is a static method (special-cased so you need not declare it as such) that takes the class of which an instance was requested as its first argument.</blockquote>
<p>It's interesting to see how this statement is embodied in the code of <tt class="docutils literal">type_new</tt>:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span style="color: #007f00">/* Special-case __new__: if it&#39;s a plain function,</span>
<span style="color: #007f00">   make it a static function */</span>
tmp = _PyDict_GetItemId(dict, &amp;PyId___new__);
<span style="color: #00007f; font-weight: bold">if</span> (tmp != <span style="color: #00007f">NULL</span> &amp;&amp; PyFunction_Check(tmp)) {
    tmp = PyStaticMethod_New(tmp);
    <span style="color: #00007f; font-weight: bold">if</span> (tmp == <span style="color: #00007f">NULL</span>)
        <span style="color: #00007f; font-weight: bold">goto</span> error;
    <span style="color: #00007f; font-weight: bold">if</span> (_PyDict_SetItemId(dict, &amp;PyId___new__, tmp) &lt; <span style="color: #007f7f">0</span>)
        <span style="color: #00007f; font-weight: bold">goto</span> error;
    Py_DECREF(tmp);
}
</pre></div>
<p>So when the dict of the new class has a <tt class="docutils literal">__new__</tt> method, it's automatically replaced with a corresponding static method.</p>
<p>After some more handling of special cases, <tt class="docutils literal">type_new</tt> returns the object representing the newly created type.</p>
</div>
<div class="section" id="conclusion">
<h3>Conclusion</h3>
<p>This has been a relatively dense article. If you got lost, don't despair. The important part to remember is the flow described in &quot;A brief recap&quot; - the rest of the article just explains the items in that list in more detail.</p>
<p>The Python type system is very powerful, dynamic and flexible. Since this all has to be implemented in the low-level and type-rigid C, and at the same time be relatively efficient, the implementation is almost inevitably complex. If you're just writing Python code, you almost definitely don't have to be aware of all these details. However, if you're writing non-trivial C extensions, and/or hacking on CPython itself, understanding the contents of this article (at least on an approximate level) can be useful and educational.</p>
<p><em>Many thanks to Nick Coghlan for reviewing this article.</em></p>
<img class="align-center" src="../../../images/hline.jpg" style="width: 320px; height: 5px;" />
<table class="docutils footnote" frame="void" id="id11" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>If you're interested in the compilation part, <a class="reference external" href="../../../2010/06/30/python-internals-adding-a-new-statement-to-python/index.html">this article</a> provides a good overview.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>In the distant past, <tt class="docutils literal">MAKE_FUNCTION</tt> was used both for creating functions and classes. However, when lexical scoping was added to Python, a new instruction for creating functions was added - <tt class="docutils literal">MAKE_CLOSURE</tt>. So nowadays, as strange as it sounds, <tt class="docutils literal">MAKE_FUNCTION</tt> is only used for creating <em>classes</em>, not <em>functions</em>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id13" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>The other keyword arguments, if they exist, are passed to the metaclass when it's getting called.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id14" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>You may find it educational to open the file <tt class="docutils literal">Python/bltinmodule.c</tt> from the Python source distribution and follow along.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id15" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td>There always is <em>some</em> metaclass, because all classes eventually derive from <tt class="docutils literal">object</tt> whose metaclass is <tt class="docutils literal">type</tt>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id16" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td>With the caveat that BBC also calls <tt class="docutils literal">__prepare__</tt>. For a more equivalent sequence, take a look at <a class="reference external" href="http://docs.python.org/dev/library/types.html?highlight=new_class#types.new_class">types.new_class</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id17" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td>As I mentioned earlier, any callable can be specified as a metaclass. If the callable is a function and not a class, it's simply called as the last step of BBC - the rest of the discussion doesn't apply.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id18" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[8]</a></td><td>I've never encountered real-world Python code where a metaclass has a metaclass of its own. If you have, please let me know - I'm genuinely curious about the use cases for such a construct.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[9]</a></td><td>If you've noticed that this is a duplication of effort, you're right. BBC also computes the metaclass, but to handle the <tt class="docutils literal"><span class="pre">type(...)</span></tt> call, <tt class="docutils literal">type_new</tt> has to do this again. I think that creating new classes is a rare enough occurrence that the extra work done here doesn't count for much.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id10">[10]</a></td><td>Since they have to be garbage collected and fully deleted when no longer needed.</td></tr>
</tbody>
</table>
</div>

    
            </div>
            <!-- /.entry-content -->
<hr/>
<div class="dotted-links">
<p class="align-center">
For comments, please send me
<a href="mailto:eliben@gmail.com"><i class="fa fa-envelope-o"></i> an email</a>.
</p>
</div>        </article>
    </section>

    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">
            &copy; 2003-2025 Eli Bendersky
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://code.jquery.com/jquery-2.2.4.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../../../theme/js/bootstrap.min.js"></script>

<!--
  Using goatcounter to count visitors. The count.js script is vendored in.
-->
<script data-goatcounter="https://stats.thegreenplace.net/count"
        async src="../../../theme/js/count.js"></script>
</body>

<!-- Mirrored from eli.thegreenplace.net/2012/06/15/under-the-hood-of-python-class-definitions by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 17 Feb 2025 00:02:56 GMT -->
</html>